name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy web-chat-emulator --project-name=chat-emulator --branch=main

      - name: Notify Telegram (success)
        if: ${{ success() && secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          MSG="$(printf 'Deploy succeeded: %s@%s\n%s\n%s' "${GITHUB_REPOSITORY}" "${GITHUB_SHA}" "${RUN_URL}" 'https://chat-emulator.pages.dev')"
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            -d "disable_web_page_preview=true" \
            > /dev/null

      - name: Notify ntfy (success)
        if: ${{ success() && secrets.NTFY_TOPIC != '' }}
        continue-on-error: true
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          set -euo pipefail
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          MSG="$(printf 'Deploy succeeded: %s@%s\n%s\n%s' "${GITHUB_REPOSITORY}" "${GITHUB_SHA}" "${RUN_URL}" 'https://chat-emulator.pages.dev')"
          curl -sS -X POST \
            -H "Title: Deploy succeeded" \
            -d "${MSG}" \
            "https://ntfy.sh/${NTFY_TOPIC}" \
            > /dev/null
